<!DOCTYPE html>





<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="以下涉及到的源码均为redis5.0-rc3版本的代码【点击查看官方源码】 服务器结构在redis的头文件server.h中定义了服务器的数据结构，略见如下：（详细的可在文末的源码部分见得） 1234567struct redisServer &amp;#123;    //服务器的一些信息    ·    ·    ·&amp;#125;">
<meta name="keywords" content="redis">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis源码剖析之服务器">
<meta property="og:url" content="https://lazycece.github.io/2019/02/09/Redis源码剖析之服务器/index.html">
<meta property="og:site_name" content="W  pit">
<meta property="og:description" content="以下涉及到的源码均为redis5.0-rc3版本的代码【点击查看官方源码】 服务器结构在redis的头文件server.h中定义了服务器的数据结构，略见如下：（详细的可在文末的源码部分见得） 1234567struct redisServer &amp;#123;    //服务器的一些信息    ·    ·    ·&amp;#125;">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2021-01-31T14:11:26.612Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Redis源码剖析之服务器">
<meta name="twitter:description" content="以下涉及到的源码均为redis5.0-rc3版本的代码【点击查看官方源码】 服务器结构在redis的头文件server.h中定义了服务器的数据结构，略见如下：（详细的可在文末的源码部分见得） 1234567struct redisServer &amp;#123;    //服务器的一些信息    ·    ·    ·&amp;#125;">
  <link rel="canonical" href="https://lazycece.github.io/2019/02/09/Redis源码剖析之服务器/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Redis源码剖析之服务器 | W  pit</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">W  pit</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">A thousand miles begins with a single step .</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a class="book-mark-link book-mark-link-fixed" href="#"></a>

  <a href="https://github.com/lazycece" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
      <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="https://lazycece.github.io/2019/02/09/Redis源码剖析之服务器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="蝉">
      <meta itemprop="description" content="Another way to laugh !">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="W  pit">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Redis源码剖析之服务器

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-02-09 17:14:32" itemprop="dateCreated datePublished" datetime="2019-02-09T17:14:32+08:00">2019-02-09</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-31 22:11:26" itemprop="dateModified" datetime="2021-01-31T22:11:26+08:00">2021-01-31</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a></span>

                
                
              
            </span>
          

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>以下涉及到的源码均为redis5.0-rc3版本的代码【<a href="https://github.com/antirez/redis/releases" target="_blank" rel="noopener">点击查看官方源码</a>】</p>
<h2 id="服务器结构"><a href="#服务器结构" class="headerlink" title="服务器结构"></a>服务器结构</h2><p>在redis的头文件server.h中定义了服务器的数据结构，略见如下：（详细的可在文末的<strong>源码</strong>部分见得）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct redisServer &#123;</span><br><span class="line"></span><br><span class="line">    //服务器的一些信息</span><br><span class="line">    ·</span><br><span class="line">    ·</span><br><span class="line">    ·</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h2 id="服务器初始化"><a href="#服务器初始化" class="headerlink" title="服务器初始化"></a>服务器初始化</h2><p>在redis服务器启动中，在服务器的初始化过程中主要由三个函数操作：</p>
<ol>
<li>initServerConfig：先初始相关配置</li>
<li>initServer：接着初始化服务器</li>
<li>serverCron：再让服务器在后台做一些定时任务操作</li>
<li>其他的一些初始化操作</li>
</ol>
<p>而这三个过程中，基本的初始化配置就不需要再说明了，可见后面源码；接下来介绍了以下<strong>serverCron</strong>函数以及其中的<strong>databasesCron</strong>函数。</p>
<h3 id="serverCron函数"><a href="#serverCron函数" class="headerlink" title="serverCron函数"></a>serverCron函数</h3><p>serverCron函数中的操作是再服务器背后定期运行的，做了一些重要的操作，比如：过期键的删除、设备软件的监控、静态变量的更新、rehash、BGSAVE/AOF的重写等等操作。具体详见函数源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line">/* This is our timer interrupt, called server.hz times per second.</span><br><span class="line"> * Here is where we do a number of things that need to be done asynchronously.</span><br><span class="line"> * For instance:</span><br><span class="line"> *</span><br><span class="line"> * - Active expired keys collection (it is also performed in a lazy way on</span><br><span class="line"> *   lookup).</span><br><span class="line"> * - Software watchdog.</span><br><span class="line"> * - Update some statistic.</span><br><span class="line"> * - Incremental rehashing of the DBs hash tables.</span><br><span class="line"> * - Triggering BGSAVE / AOF rewrite, and handling of terminated children.</span><br><span class="line"> * - Clients timeout of different kinds.</span><br><span class="line"> * - Replication reconnection.</span><br><span class="line"> * - Many more...</span><br><span class="line"> *</span><br><span class="line"> * Everything directly called here will be called server.hz times per second,</span><br><span class="line"> * so in order to throttle execution of things we want to do less frequently</span><br><span class="line"> * a macro is used: run_with_period(milliseconds) &#123; .... &#125;</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">int serverCron(struct aeEventLoop *eventLoop, long long id, void *clientData) &#123;</span><br><span class="line">    int j;</span><br><span class="line">    UNUSED(eventLoop);</span><br><span class="line">    UNUSED(id);</span><br><span class="line">    UNUSED(clientData);</span><br><span class="line"></span><br><span class="line">    /* Software watchdog: deliver the SIGALRM that will reach the signal</span><br><span class="line">     * handler if we don&apos;t return here fast enough. */</span><br><span class="line">    if (server.watchdog_period) watchdogScheduleSignal(server.watchdog_period);</span><br><span class="line"></span><br><span class="line">    //更新时间缓存</span><br><span class="line">    updateCachedTime();</span><br><span class="line"></span><br><span class="line">    //每100毫秒运行一次</span><br><span class="line">    run_with_period(100) &#123;</span><br><span class="line">        trackInstantaneousMetric(STATS_METRIC_COMMAND,server.stat_numcommands);</span><br><span class="line">        trackInstantaneousMetric(STATS_METRIC_NET_INPUT,</span><br><span class="line">                server.stat_net_input_bytes);</span><br><span class="line">        trackInstantaneousMetric(STATS_METRIC_NET_OUTPUT,</span><br><span class="line">                server.stat_net_output_bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* We have just LRU_BITS bits per object for LRU information.</span><br><span class="line">     * So we use an (eventually wrapping) LRU clock.</span><br><span class="line">     *</span><br><span class="line">     * Note that even if the counter wraps it&apos;s not a big problem,</span><br><span class="line">     * everything will still work but some object will appear younger</span><br><span class="line">     * to Redis. However for this to happen a given object should never be</span><br><span class="line">     * touched for all the time needed to the counter to wrap, which is</span><br><span class="line">     * not likely.</span><br><span class="line">     *</span><br><span class="line">     * Note that you can change the resolution altering the</span><br><span class="line">     * LRU_CLOCK_RESOLUTION define. */</span><br><span class="line">    unsigned long lruclock = getLRUClock();</span><br><span class="line">    atomicSet(server.lruclock,lruclock);</span><br><span class="line"></span><br><span class="line">    记录自服务器启动以来的已使用的内存</span><br><span class="line">    if (zmalloc_used_memory() &gt; server.stat_peak_memory)</span><br><span class="line">        server.stat_peak_memory = zmalloc_used_memory();</span><br><span class="line"></span><br><span class="line">    //每100毫秒运行一次</span><br><span class="line">    run_with_period(100) &#123;</span><br><span class="line">        /* Sample the RSS and other metrics here since this is a relatively slow call.</span><br><span class="line">         * We must sample the zmalloc_used at the same time we take the rss, otherwise</span><br><span class="line">         * the frag ratio calculate may be off (ratio of two samples at different times) */</span><br><span class="line">        server.cron_malloc_stats.process_rss = zmalloc_get_rss();</span><br><span class="line">        server.cron_malloc_stats.zmalloc_used = zmalloc_used_memory();</span><br><span class="line">        /* Sampling the allcator info can be slow too.</span><br><span class="line">         * The fragmentation ratio it&apos;ll show is potentically more accurate</span><br><span class="line">         * it excludes other RSS pages such as: shared libraries, LUA and other non-zmalloc</span><br><span class="line">         * allocations, and allocator reserved pages that can be pursed (all not actual frag) */</span><br><span class="line">        zmalloc_get_allocator_info(&amp;server.cron_malloc_stats.allocator_allocated,</span><br><span class="line">                                   &amp;server.cron_malloc_stats.allocator_active,</span><br><span class="line">                                   &amp;server.cron_malloc_stats.allocator_resident);</span><br><span class="line">        /* in case the allocator isn&apos;t providing these stats, fake them so that</span><br><span class="line">         * fragmention info still shows some (inaccurate metrics) */</span><br><span class="line">        if (!server.cron_malloc_stats.allocator_resident) &#123;</span><br><span class="line">            /* LUA memory isn&apos;t part of zmalloc_used, but it is part of the process RSS,</span><br><span class="line">             * so we must desuct it in order to be able to calculate correct</span><br><span class="line">             * &quot;allocator fragmentation&quot; ratio */</span><br><span class="line">            size_t lua_memory = lua_gc(server.lua,LUA_GCCOUNT,0)*1024LL;</span><br><span class="line">            server.cron_malloc_stats.allocator_resident = server.cron_malloc_stats.process_rss - lua_memory;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!server.cron_malloc_stats.allocator_active)</span><br><span class="line">            server.cron_malloc_stats.allocator_active = server.cron_malloc_stats.allocator_resident;</span><br><span class="line">        if (!server.cron_malloc_stats.allocator_allocated)</span><br><span class="line">            server.cron_malloc_stats.allocator_allocated = server.cron_malloc_stats.zmalloc_used;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //接收一个SIGTERM信好去安全的关闭服务（避免出现不安全操作）</span><br><span class="line">    if (server.shutdown_asap) &#123;</span><br><span class="line">        if (prepareForShutdown(SHUTDOWN_NOFLAGS) == C_OK) exit(0);</span><br><span class="line">        serverLog(LL_WARNING,&quot;SIGTERM received but errors trying to shut down the server, check the logs for more information&quot;);</span><br><span class="line">        server.shutdown_asap = 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //展示非空数据库的信息</span><br><span class="line">    run_with_period(5000) &#123;</span><br><span class="line">        for (j = 0; j &lt; server.dbnum; j++) &#123;</span><br><span class="line">            long long size, used, vkeys;</span><br><span class="line"></span><br><span class="line">            size = dictSlots(server.db[j].dict);</span><br><span class="line">            used = dictSize(server.db[j].dict);</span><br><span class="line">            vkeys = dictSize(server.db[j].expires);</span><br><span class="line">            if (used || vkeys) &#123;</span><br><span class="line">                serverLog(LL_VERBOSE,&quot;DB %d: %lld keys (%lld volatile) in %lld slots HT.&quot;,j,used,vkeys,size);</span><br><span class="line">                /* dictPrintStats(server.dict); */</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //展示连接的客户端的信息</span><br><span class="line">    if (!server.sentinel_mode) &#123;</span><br><span class="line">        run_with_period(5000) &#123;</span><br><span class="line">            serverLog(LL_VERBOSE,</span><br><span class="line">                &quot;%lu clients connected (%lu slaves), %zu bytes in use&quot;,</span><br><span class="line">                listLength(server.clients)-listLength(server.slaves),</span><br><span class="line">                listLength(server.slaves),</span><br><span class="line">                zmalloc_used_memory());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //客户端的一些异步操作</span><br><span class="line">    clientsCron();</span><br><span class="line"></span><br><span class="line">    //后台对database的一些运行操作</span><br><span class="line">    databasesCron();</span><br><span class="line"></span><br><span class="line">    //aop重写操作</span><br><span class="line">    if (server.rdb_child_pid == -1 &amp;&amp; server.aof_child_pid == -1 &amp;&amp;</span><br><span class="line">        server.aof_rewrite_scheduled)</span><br><span class="line">    &#123;</span><br><span class="line">        rewriteAppendOnlyFileBackground();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //检查是否有在后台运行rdbsava和aop重写操作</span><br><span class="line">    if (server.rdb_child_pid != -1 || server.aof_child_pid != -1 ||</span><br><span class="line">        ldbPendingChildren())</span><br><span class="line">    &#123;</span><br><span class="line">        int statloc;</span><br><span class="line">        pid_t pid;</span><br><span class="line"></span><br><span class="line">        if ((pid = wait3(&amp;statloc,WNOHANG,NULL)) != 0) &#123;</span><br><span class="line">            int exitcode = WEXITSTATUS(statloc);</span><br><span class="line">            int bysignal = 0;</span><br><span class="line"></span><br><span class="line">            if (WIFSIGNALED(statloc)) bysignal = WTERMSIG(statloc);</span><br><span class="line"></span><br><span class="line">            if (pid == -1) &#123;</span><br><span class="line">                serverLog(LL_WARNING,&quot;wait3() returned an error: %s. &quot;</span><br><span class="line">                    &quot;rdb_child_pid = %d, aof_child_pid = %d&quot;,</span><br><span class="line">                    strerror(errno),</span><br><span class="line">                    (int) server.rdb_child_pid,</span><br><span class="line">                    (int) server.aof_child_pid);</span><br><span class="line">            &#125; else if (pid == server.rdb_child_pid) &#123;</span><br><span class="line">                backgroundSaveDoneHandler(exitcode,bysignal);</span><br><span class="line">                if (!bysignal &amp;&amp; exitcode == 0) receiveChildInfo();</span><br><span class="line">            &#125; else if (pid == server.aof_child_pid) &#123;</span><br><span class="line">                backgroundRewriteDoneHandler(exitcode,bysignal);</span><br><span class="line">                if (!bysignal &amp;&amp; exitcode == 0) receiveChildInfo();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (!ldbRemoveChild(pid)) &#123;</span><br><span class="line">                    serverLog(LL_WARNING,</span><br><span class="line">                        &quot;Warning, detected child with unmatched pid: %ld&quot;,</span><br><span class="line">                        (long)pid);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            updateDictResizePolicy();</span><br><span class="line">            closeChildInfoPipe();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        /* If there is not a background saving/rewrite in progress check if</span><br><span class="line">         * we have to save/rewrite now. */</span><br><span class="line">         for (j = 0; j &lt; server.saveparamslen; j++) &#123;</span><br><span class="line">            struct saveparam *sp = server.saveparams+j;</span><br><span class="line"></span><br><span class="line">            /* Save if we reached the given amount of changes,</span><br><span class="line">             * the given amount of seconds, and if the latest bgsave was</span><br><span class="line">             * successful or if, in case of an error, at least</span><br><span class="line">             * CONFIG_BGSAVE_RETRY_DELAY seconds already elapsed. */</span><br><span class="line">            if (server.dirty &gt;= sp-&gt;changes &amp;&amp;</span><br><span class="line">                server.unixtime-server.lastsave &gt; sp-&gt;seconds &amp;&amp;</span><br><span class="line">                (server.unixtime-server.lastbgsave_try &gt;</span><br><span class="line">                 CONFIG_BGSAVE_RETRY_DELAY ||</span><br><span class="line">                 server.lastbgsave_status == C_OK))</span><br><span class="line">            &#123;</span><br><span class="line">                serverLog(LL_NOTICE,&quot;%d changes in %d seconds. Saving...&quot;,</span><br><span class="line">                    sp-&gt;changes, (int)sp-&gt;seconds);</span><br><span class="line">                rdbSaveInfo rsi, *rsiptr;</span><br><span class="line">                rsiptr = rdbPopulateSaveInfo(&amp;rsi);</span><br><span class="line">                rdbSaveBackground(server.rdb_filename,rsiptr);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         //在条件满足的情况下触发aof重写操作</span><br><span class="line">         if (server.aof_state == AOF_ON &amp;&amp;</span><br><span class="line">             server.rdb_child_pid == -1 &amp;&amp;</span><br><span class="line">             server.aof_child_pid == -1 &amp;&amp;</span><br><span class="line">             server.aof_rewrite_perc &amp;&amp;</span><br><span class="line">             server.aof_current_size &gt; server.aof_rewrite_min_size)</span><br><span class="line">         &#123;</span><br><span class="line">            long long base = server.aof_rewrite_base_size ?</span><br><span class="line">                            server.aof_rewrite_base_size : 1;</span><br><span class="line">            long long growth = (server.aof_current_size*100/base) - 100;</span><br><span class="line">            if (growth &gt;= server.aof_rewrite_perc) &#123;</span><br><span class="line">                serverLog(LL_NOTICE,&quot;Starting automatic rewriting of AOF on %lld%% growth&quot;,growth);</span><br><span class="line">                rewriteAppendOnlyFileBackground();</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     //如果之前的执行周期还未完成，则延迟清楚buffer</span><br><span class="line">    if (server.aof_flush_postponed_start) flushAppendOnlyFile(0);</span><br><span class="line"></span><br><span class="line">    /* AOF write errors: in this case we have a buffer to flush as well and</span><br><span class="line">     * clear the AOF error in case of success to make the DB writable again,</span><br><span class="line">     * however to try every second is enough in case of &apos;hz&apos; is set to</span><br><span class="line">     * an higher frequency. */</span><br><span class="line">    run_with_period(1000) &#123;</span><br><span class="line">        if (server.aof_last_write_status == C_ERR)</span><br><span class="line">            flushAppendOnlyFile(0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //释放客户端</span><br><span class="line">    freeClientsInAsyncFreeQueue();</span><br><span class="line"></span><br><span class="line">    //清楚已暂停使用的客户端</span><br><span class="line">    clientsArePaused(); </span><br><span class="line"></span><br><span class="line">    /* Replication cron function -- used to reconnect to master,</span><br><span class="line">     * detect transfer failures, start background RDB transfers and so forth. */</span><br><span class="line">    run_with_period(1000) replicationCron();</span><br><span class="line"></span><br><span class="line">    run_with_period(100) &#123;</span><br><span class="line">        //如果是集群模式，则每100毫秒执行一次集群模式下相关的事件</span><br><span class="line">        if (server.cluster_enabled) clusterCron();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    run_with_period(100) &#123;</span><br><span class="line">        //如果sentinel模式存在，则没100毫秒执行一次哨兵模式下的一些事件</span><br><span class="line">        if (server.sentinel_mode) sentinelTimer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    run_with_period(1000) &#123;</span><br><span class="line">        //每秒清理一次废弃的sockets链接</span><br><span class="line">        migrateCloseTimedoutSockets();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* Start a scheduled BGSAVE if the corresponding flag is set. This is</span><br><span class="line">     * useful when we are forced to postpone a BGSAVE because an AOF</span><br><span class="line">     * rewrite is in progress.</span><br><span class="line">     *</span><br><span class="line">     * Note: this code must be after the replicationCron() call above so</span><br><span class="line">     * make sure when refactoring this file to keep this order. This is useful</span><br><span class="line">     * because we want to give priority to RDB savings for replication. */</span><br><span class="line">    if (server.rdb_child_pid == -1 &amp;&amp; server.aof_child_pid == -1 &amp;&amp;</span><br><span class="line">        server.rdb_bgsave_scheduled &amp;&amp;</span><br><span class="line">        (server.unixtime-server.lastbgsave_try &gt; CONFIG_BGSAVE_RETRY_DELAY ||</span><br><span class="line">         server.lastbgsave_status == C_OK))</span><br><span class="line">    &#123;</span><br><span class="line">        rdbSaveInfo rsi, *rsiptr;</span><br><span class="line">        rsiptr = rdbPopulateSaveInfo(&amp;rsi);</span><br><span class="line">        if (rdbSaveBackground(server.rdb_filename,rsiptr) == C_OK)</span><br><span class="line">            server.rdb_bgsave_scheduled = 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server.cronloops++;</span><br><span class="line">    return 1000/server.hz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="databasesCron"><a href="#databasesCron" class="headerlink" title="databasesCron"></a>databasesCron</h3><p>databasesCron是serverCron中的一个子函数，其执行时间为每100ms执行一次。主要的功能是去执行一些数据库的增量操作，比如键的过期，空间的resizing和hash表的rehashing操作等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">/* This function handles &apos;background&apos; operations we are required to do</span><br><span class="line"> * incrementally in Redis databases, such as active key expiring, resizing,</span><br><span class="line"> * rehashing. */</span><br><span class="line">void databasesCron(void) &#123;</span><br><span class="line">    /* Expire keys by random sampling. Not required for slaves</span><br><span class="line">     * as master will synthesize DELs for us. */</span><br><span class="line">    if (server.active_expire_enabled &amp;&amp; server.masterhost == NULL) &#123;</span><br><span class="line">        activeExpireCycle(ACTIVE_EXPIRE_CYCLE_SLOW);</span><br><span class="line">    &#125; else if (server.masterhost != NULL) &#123;</span><br><span class="line">        expireSlaveKeys();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* Defrag keys gradually. */</span><br><span class="line">    if (server.active_defrag_enabled)</span><br><span class="line">        activeDefragCycle();</span><br><span class="line"></span><br><span class="line">    /* Perform hash tables rehashing if needed, but only if there are no</span><br><span class="line">     * other processes saving the DB on disk. Otherwise rehashing is bad</span><br><span class="line">     * as will cause a lot of copy-on-write of memory pages. */</span><br><span class="line">    if (server.rdb_child_pid == -1 &amp;&amp; server.aof_child_pid == -1) &#123;</span><br><span class="line">        /* We use global counters so if we stop the computation at a given</span><br><span class="line">         * DB we&apos;ll be able to start from the successive in the next</span><br><span class="line">         * cron loop iteration. */</span><br><span class="line">        static unsigned int resize_db = 0;</span><br><span class="line">        static unsigned int rehash_db = 0;</span><br><span class="line">        int dbs_per_call = CRON_DBS_PER_CALL;  //server.h中宏定义 #define CRON_DBS_PER_CALL 16</span><br><span class="line">        int j;</span><br><span class="line"></span><br><span class="line">        /* Don&apos;t test more DBs than we have. */</span><br><span class="line">        if (dbs_per_call &gt; server.dbnum) dbs_per_call = server.dbnum;</span><br><span class="line"></span><br><span class="line">        /* Resize */</span><br><span class="line">        for (j = 0; j &lt; dbs_per_call; j++) &#123;</span><br><span class="line">            tryResizeHashTables(resize_db % server.dbnum);</span><br><span class="line">            resize_db++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /* Rehash */</span><br><span class="line">        if (server.activerehashing) &#123;</span><br><span class="line">            for (j = 0; j &lt; dbs_per_call; j++) &#123;</span><br><span class="line">                int work_done = incrementallyRehash(rehash_db);</span><br><span class="line">                if (work_done) &#123;</span><br><span class="line">                    /* If the function did some work, stop here, we&apos;ll do</span><br><span class="line">                     * more at the next cron loop. */</span><br><span class="line">                    break;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    /* If this db didn&apos;t need rehash, we&apos;ll try the next one. */</span><br><span class="line">                    rehash_db++;</span><br><span class="line">                    rehash_db %= server.dbnum;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* Our hash table implementation performs rehashing incrementally while</span><br><span class="line"> * we write/read from the hash table. Still if the server is idle, the hash</span><br><span class="line"> * table will use two tables for a long time. So we try to use 1 millisecond</span><br><span class="line"> * of CPU time at every call of this function to perform some rehahsing.</span><br><span class="line"> *</span><br><span class="line"> * The function returns 1 if some rehashing was performed, otherwise 0</span><br><span class="line"> * is returned. */</span><br><span class="line">int incrementallyRehash(int dbid) &#123;</span><br><span class="line">    /* Keys dictionary */</span><br><span class="line">    if (dictIsRehashing(server.db[dbid].dict)) &#123;</span><br><span class="line">        dictRehashMilliseconds(server.db[dbid].dict,1);</span><br><span class="line">        return 1; /* already used our millisecond for this loop... */</span><br><span class="line">    &#125;</span><br><span class="line">    /* Expires */</span><br><span class="line">    if (dictIsRehashing(server.db[dbid].expires)) &#123;</span><br><span class="line">        dictRehashMilliseconds(server.db[dbid].expires,1);</span><br><span class="line">        return 1; /* already used our millisecond for this loop... */</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="redisServer-initServerConfig-initServer源码"><a href="#redisServer-initServerConfig-initServer源码" class="headerlink" title="redisServer/initServerConfig/initServer源码"></a>redisServer/initServerConfig/initServer源码</h2><p>这里贴身三个函数的源码，更详细的服务器启动初始化详见源码中的server.c文件。</p>
<h3 id="redisServer"><a href="#redisServer" class="headerlink" title="redisServer"></a>redisServer</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br></pre></td><td class="code"><pre><span class="line">struct redisServer &#123;</span><br><span class="line">    /* General */</span><br><span class="line">    pid_t pid;                  /* Main process pid. */</span><br><span class="line">    char *configfile;           /* Absolute config file path, or NULL */</span><br><span class="line">    char *executable;           /* Absolute executable file path. */</span><br><span class="line">    char **exec_argv;           /* Executable argv vector (copy). */</span><br><span class="line">    int hz;                     /* serverCron() calls frequency in hertz */</span><br><span class="line">    redisDb *db;</span><br><span class="line">    dict *commands;             /* Command table */</span><br><span class="line">    dict *orig_commands;        /* Command table before command renaming. */</span><br><span class="line">    aeEventLoop *el;</span><br><span class="line">    unsigned int lruclock;      /* Clock for LRU eviction */</span><br><span class="line">    int shutdown_asap;          /* SHUTDOWN needed ASAP */</span><br><span class="line">    int activerehashing;        /* Incremental rehash in serverCron() */</span><br><span class="line">    int active_defrag_running;  /* Active defragmentation running (holds current scan aggressiveness) */</span><br><span class="line">    char *requirepass;          /* Pass for AUTH command, or NULL */</span><br><span class="line">    char *pidfile;              /* PID file path */</span><br><span class="line">    int arch_bits;              /* 32 or 64 depending on sizeof(long) */</span><br><span class="line">    int cronloops;              /* Number of times the cron function run */</span><br><span class="line">    char runid[CONFIG_RUN_ID_SIZE+1];  /* ID always different at every exec. */</span><br><span class="line">    int sentinel_mode;          /* True if this instance is a Sentinel. */</span><br><span class="line">    size_t initial_memory_usage; /* Bytes used after initialization. */</span><br><span class="line">    int always_show_logo;       /* Show logo even for non-stdout logging. */</span><br><span class="line">    /* Modules */</span><br><span class="line">    dict *moduleapi;            /* Exported APIs dictionary for modules. */</span><br><span class="line">    list *loadmodule_queue;     /* List of modules to load at startup. */</span><br><span class="line">    int module_blocked_pipe[2]; /* Pipe used to awake the event loop if a</span><br><span class="line">                                   client blocked on a module command needs</span><br><span class="line">                                   to be processed. */</span><br><span class="line">    /* Networking */</span><br><span class="line">    int port;                   /* TCP listening port */</span><br><span class="line">    int tcp_backlog;            /* TCP listen() backlog */</span><br><span class="line">    char *bindaddr[CONFIG_BINDADDR_MAX]; /* Addresses we should bind to */</span><br><span class="line">    int bindaddr_count;         /* Number of addresses in server.bindaddr[] */</span><br><span class="line">    char *unixsocket;           /* UNIX socket path */</span><br><span class="line">    mode_t unixsocketperm;      /* UNIX socket permission */</span><br><span class="line">    int ipfd[CONFIG_BINDADDR_MAX]; /* TCP socket file descriptors */</span><br><span class="line">    int ipfd_count;             /* Used slots in ipfd[] */</span><br><span class="line">    int sofd;                   /* Unix socket file descriptor */</span><br><span class="line">    int cfd[CONFIG_BINDADDR_MAX];/* Cluster bus listening socket */</span><br><span class="line">    int cfd_count;              /* Used slots in cfd[] */</span><br><span class="line">    list *clients;              /* List of active clients */</span><br><span class="line">    list *clients_to_close;     /* Clients to close asynchronously */</span><br><span class="line">    list *clients_pending_write; /* There is to write or install handler. */</span><br><span class="line">    list *slaves, *monitors;    /* List of slaves and MONITORs */</span><br><span class="line">    client *current_client; /* Current client, only used on crash report */</span><br><span class="line">    int clients_paused;         /* True if clients are currently paused */</span><br><span class="line">    mstime_t clients_pause_end_time; /* Time when we undo clients_paused */</span><br><span class="line">    char neterr[ANET_ERR_LEN];   /* Error buffer for anet.c */</span><br><span class="line">    dict *migrate_cached_sockets;/* MIGRATE cached sockets */</span><br><span class="line">    uint64_t next_client_id;    /* Next client unique ID. Incremental. */</span><br><span class="line">    int protected_mode;         /* Don&apos;t accept external connections. */</span><br><span class="line">    /* RDB / AOF loading information */</span><br><span class="line">    int loading;                /* We are loading data from disk if true */</span><br><span class="line">    off_t loading_total_bytes;</span><br><span class="line">    off_t loading_loaded_bytes;</span><br><span class="line">    time_t loading_start_time;</span><br><span class="line">    off_t loading_process_events_interval_bytes;</span><br><span class="line">    /* Fast pointers to often looked up command */</span><br><span class="line">    struct redisCommand *delCommand, *multiCommand, *lpushCommand,</span><br><span class="line">                        *lpopCommand, *rpopCommand, *zpopminCommand,</span><br><span class="line">                        *zpopmaxCommand, *sremCommand, *execCommand,</span><br><span class="line">                        *expireCommand, *pexpireCommand, *xclaimCommand;</span><br><span class="line">    /* Fields used only for stats */</span><br><span class="line">    time_t stat_starttime;          /* Server start time */</span><br><span class="line">    long long stat_numcommands;     /* Number of processed commands */</span><br><span class="line">    long long stat_numconnections;  /* Number of connections received */</span><br><span class="line">    long long stat_expiredkeys;     /* Number of expired keys */</span><br><span class="line">    double stat_expired_stale_perc; /* Percentage of keys probably expired */</span><br><span class="line">    long long stat_expired_time_cap_reached_count; /* Early expire cylce stops.*/</span><br><span class="line">    long long stat_evictedkeys;     /* Number of evicted keys (maxmemory) */</span><br><span class="line">    long long stat_keyspace_hits;   /* Number of successful lookups of keys */</span><br><span class="line">    long long stat_keyspace_misses; /* Number of failed lookups of keys */</span><br><span class="line">    long long stat_active_defrag_hits;      /* number of allocations moved */</span><br><span class="line">    long long stat_active_defrag_misses;    /* number of allocations scanned but not moved */</span><br><span class="line">    long long stat_active_defrag_key_hits;  /* number of keys with moved allocations */</span><br><span class="line">    long long stat_active_defrag_key_misses;/* number of keys scanned and not moved */</span><br><span class="line">    long long stat_active_defrag_scanned;   /* number of dictEntries scanned */</span><br><span class="line">    size_t stat_peak_memory;        /* Max used memory record */</span><br><span class="line">    long long stat_fork_time;       /* Time needed to perform latest fork() */</span><br><span class="line">    double stat_fork_rate;          /* Fork rate in GB/sec. */</span><br><span class="line">    long long stat_rejected_conn;   /* Clients rejected because of maxclients */</span><br><span class="line">    long long stat_sync_full;       /* Number of full resyncs with slaves. */</span><br><span class="line">    long long stat_sync_partial_ok; /* Number of accepted PSYNC requests. */</span><br><span class="line">    long long stat_sync_partial_err;/* Number of unaccepted PSYNC requests. */</span><br><span class="line">    list *slowlog;                  /* SLOWLOG list of commands */</span><br><span class="line">    long long slowlog_entry_id;     /* SLOWLOG current entry ID */</span><br><span class="line">    long long slowlog_log_slower_than; /* SLOWLOG time limit (to get logged) */</span><br><span class="line">    unsigned long slowlog_max_len;     /* SLOWLOG max number of items logged */</span><br><span class="line">    malloc_stats cron_malloc_stats; /* sampled in serverCron(). */</span><br><span class="line">    long long stat_net_input_bytes; /* Bytes read from network. */</span><br><span class="line">    long long stat_net_output_bytes; /* Bytes written to network. */</span><br><span class="line">    size_t stat_rdb_cow_bytes;      /* Copy on write bytes during RDB saving. */</span><br><span class="line">    size_t stat_aof_cow_bytes;      /* Copy on write bytes during AOF rewrite. */</span><br><span class="line">    /* The following two are used to track instantaneous metrics, like</span><br><span class="line">     * number of operations per second, network traffic. */</span><br><span class="line">    struct &#123;</span><br><span class="line">        long long last_sample_time; /* Timestamp of last sample in ms */</span><br><span class="line">        long long last_sample_count;/* Count in last sample */</span><br><span class="line">        long long samples[STATS_METRIC_SAMPLES];</span><br><span class="line">        int idx;</span><br><span class="line">    &#125; inst_metric[STATS_METRIC_COUNT];</span><br><span class="line">    /* Configuration */</span><br><span class="line">    int verbosity;                  /* Loglevel in redis.conf */</span><br><span class="line">    int maxidletime;                /* Client timeout in seconds */</span><br><span class="line">    int tcpkeepalive;               /* Set SO_KEEPALIVE if non-zero. */</span><br><span class="line">    int active_expire_enabled;      /* Can be disabled for testing purposes. */</span><br><span class="line">    int active_defrag_enabled;</span><br><span class="line">    size_t active_defrag_ignore_bytes; /* minimum amount of fragmentation waste to start active defrag */</span><br><span class="line">    int active_defrag_threshold_lower; /* minimum percentage of fragmentation to start active defrag */</span><br><span class="line">    int active_defrag_threshold_upper; /* maximum percentage of fragmentation at which we use maximum effort */</span><br><span class="line">    int active_defrag_cycle_min;       /* minimal effort for defrag in CPU percentage */</span><br><span class="line">    int active_defrag_cycle_max;       /* maximal effort for defrag in CPU percentage */</span><br><span class="line">    unsigned long active_defrag_max_scan_fields; /* maximum number of fields of set/hash/zset/list to process from within the main dict scan */</span><br><span class="line">    size_t client_max_querybuf_len; /* Limit for client query buffer length */</span><br><span class="line">    int dbnum;                      /* Total number of configured DBs */</span><br><span class="line">    int supervised;                 /* 1 if supervised, 0 otherwise. */</span><br><span class="line">    int supervised_mode;            /* See SUPERVISED_* */</span><br><span class="line">    int daemonize;                  /* True if running as a daemon */</span><br><span class="line">    clientBufferLimitsConfig client_obuf_limits[CLIENT_TYPE_OBUF_COUNT];</span><br><span class="line">    /* AOF persistence */</span><br><span class="line">    int aof_state;                  /* AOF_(ON|OFF|WAIT_REWRITE) */</span><br><span class="line">    int aof_fsync;                  /* Kind of fsync() policy */</span><br><span class="line">    char *aof_filename;             /* Name of the AOF file */</span><br><span class="line">    int aof_no_fsync_on_rewrite;    /* Don&apos;t fsync if a rewrite is in prog. */</span><br><span class="line">    int aof_rewrite_perc;           /* Rewrite AOF if % growth is &gt; M and... */</span><br><span class="line">    off_t aof_rewrite_min_size;     /* the AOF file is at least N bytes. */</span><br><span class="line">    off_t aof_rewrite_base_size;    /* AOF size on latest startup or rewrite. */</span><br><span class="line">    off_t aof_current_size;         /* AOF current size. */</span><br><span class="line">    int aof_rewrite_scheduled;      /* Rewrite once BGSAVE terminates. */</span><br><span class="line">    pid_t aof_child_pid;            /* PID if rewriting process */</span><br><span class="line">    list *aof_rewrite_buf_blocks;   /* Hold changes during an AOF rewrite. */</span><br><span class="line">    sds aof_buf;      /* AOF buffer, written before entering the event loop */</span><br><span class="line">    int aof_fd;       /* File descriptor of currently selected AOF file */</span><br><span class="line">    int aof_selected_db; /* Currently selected DB in AOF */</span><br><span class="line">    time_t aof_flush_postponed_start; /* UNIX time of postponed AOF flush */</span><br><span class="line">    time_t aof_last_fsync;            /* UNIX time of last fsync() */</span><br><span class="line">    time_t aof_rewrite_time_last;   /* Time used by last AOF rewrite run. */</span><br><span class="line">    time_t aof_rewrite_time_start;  /* Current AOF rewrite start time. */</span><br><span class="line">    int aof_lastbgrewrite_status;   /* C_OK or C_ERR */</span><br><span class="line">    unsigned long aof_delayed_fsync;  /* delayed AOF fsync() counter */</span><br><span class="line">    int aof_rewrite_incremental_fsync;/* fsync incrementally while rewriting? */</span><br><span class="line">    int aof_last_write_status;      /* C_OK or C_ERR */</span><br><span class="line">    int aof_last_write_errno;       /* Valid if aof_last_write_status is ERR */</span><br><span class="line">    int aof_load_truncated;         /* Don&apos;t stop on unexpected AOF EOF. */</span><br><span class="line">    int aof_use_rdb_preamble;       /* Use RDB preamble on AOF rewrites. */</span><br><span class="line">    /* AOF pipes used to communicate between parent and child during rewrite. */</span><br><span class="line">    int aof_pipe_write_data_to_child;</span><br><span class="line">    int aof_pipe_read_data_from_parent;</span><br><span class="line">    int aof_pipe_write_ack_to_parent;</span><br><span class="line">    int aof_pipe_read_ack_from_child;</span><br><span class="line">    int aof_pipe_write_ack_to_child;</span><br><span class="line">    int aof_pipe_read_ack_from_parent;</span><br><span class="line">    int aof_stop_sending_diff;     /* If true stop sending accumulated diffs</span><br><span class="line">                                      to child process. */</span><br><span class="line">    sds aof_child_diff;             /* AOF diff accumulator child side. */</span><br><span class="line">    /* RDB persistence */</span><br><span class="line">    long long dirty;                /* Changes to DB from the last save */</span><br><span class="line">    long long dirty_before_bgsave;  /* Used to restore dirty on failed BGSAVE */</span><br><span class="line">    pid_t rdb_child_pid;            /* PID of RDB saving child */</span><br><span class="line">    struct saveparam *saveparams;   /* Save points array for RDB */</span><br><span class="line">    int saveparamslen;              /* Number of saving points */</span><br><span class="line">    char *rdb_filename;             /* Name of RDB file */</span><br><span class="line">    int rdb_compression;            /* Use compression in RDB? */</span><br><span class="line">    int rdb_checksum;               /* Use RDB checksum? */</span><br><span class="line">    time_t lastsave;                /* Unix time of last successful save */</span><br><span class="line">    time_t lastbgsave_try;          /* Unix time of last attempted bgsave */</span><br><span class="line">    time_t rdb_save_time_last;      /* Time used by last RDB save run. */</span><br><span class="line">    time_t rdb_save_time_start;     /* Current RDB save start time. */</span><br><span class="line">    int rdb_bgsave_scheduled;       /* BGSAVE when possible if true. */</span><br><span class="line">    int rdb_child_type;             /* Type of save by active child. */</span><br><span class="line">    int lastbgsave_status;          /* C_OK or C_ERR */</span><br><span class="line">    int stop_writes_on_bgsave_err;  /* Don&apos;t allow writes if can&apos;t BGSAVE */</span><br><span class="line">    int rdb_pipe_write_result_to_parent; /* RDB pipes used to return the state */</span><br><span class="line">    int rdb_pipe_read_result_from_child; /* of each slave in diskless SYNC. */</span><br><span class="line">    /* Pipe and data structures for child -&gt; parent info sharing. */</span><br><span class="line">    int child_info_pipe[2];         /* Pipe used to write the child_info_data. */</span><br><span class="line">    struct &#123;</span><br><span class="line">        int process_type;           /* AOF or RDB child? */</span><br><span class="line">        size_t cow_size;            /* Copy on write size. */</span><br><span class="line">        unsigned long long magic;   /* Magic value to make sure data is valid. */</span><br><span class="line">    &#125; child_info_data;</span><br><span class="line">    /* Propagation of commands in AOF / replication */</span><br><span class="line">    redisOpArray also_propagate;    /* Additional command to propagate. */</span><br><span class="line">    /* Logging */</span><br><span class="line">    char *logfile;                  /* Path of log file */</span><br><span class="line">    int syslog_enabled;             /* Is syslog enabled? */</span><br><span class="line">    char *syslog_ident;             /* Syslog ident */</span><br><span class="line">    int syslog_facility;            /* Syslog facility */</span><br><span class="line">    /* Replication (master) */</span><br><span class="line">    char replid[CONFIG_RUN_ID_SIZE+1];  /* My current replication ID. */</span><br><span class="line">    char replid2[CONFIG_RUN_ID_SIZE+1]; /* replid inherited from master*/</span><br><span class="line">    long long master_repl_offset;   /* My current replication offset */</span><br><span class="line">    long long second_replid_offset; /* Accept offsets up to this for replid2. */</span><br><span class="line">    int slaveseldb;                 /* Last SELECTed DB in replication output */</span><br><span class="line">    int repl_ping_slave_period;     /* Master pings the slave every N seconds */</span><br><span class="line">    char *repl_backlog;             /* Replication backlog for partial syncs */</span><br><span class="line">    long long repl_backlog_size;    /* Backlog circular buffer size */</span><br><span class="line">    long long repl_backlog_histlen; /* Backlog actual data length */</span><br><span class="line">    long long repl_backlog_idx;     /* Backlog circular buffer current offset,</span><br><span class="line">                                       that is the next byte will&apos;ll write to.*/</span><br><span class="line">    long long repl_backlog_off;     /* Replication &quot;master offset&quot; of first</span><br><span class="line">                                       byte in the replication backlog buffer.*/</span><br><span class="line">    time_t repl_backlog_time_limit; /* Time without slaves after the backlog</span><br><span class="line">                                       gets released. */</span><br><span class="line">    time_t repl_no_slaves_since;    /* We have no slaves since that time.</span><br><span class="line">                                       Only valid if server.slaves len is 0. */</span><br><span class="line">    int repl_min_slaves_to_write;   /* Min number of slaves to write. */</span><br><span class="line">    int repl_min_slaves_max_lag;    /* Max lag of &lt;count&gt; slaves to write. */</span><br><span class="line">    int repl_good_slaves_count;     /* Number of slaves with lag &lt;= max_lag. */</span><br><span class="line">    int repl_diskless_sync;         /* Send RDB to slaves sockets directly. */</span><br><span class="line">    int repl_diskless_sync_delay;   /* Delay to start a diskless repl BGSAVE. */</span><br><span class="line">    /* Replication (slave) */</span><br><span class="line">    char *masterauth;               /* AUTH with this password with master */</span><br><span class="line">    char *masterhost;               /* Hostname of master */</span><br><span class="line">    int masterport;                 /* Port of master */</span><br><span class="line">    int repl_timeout;               /* Timeout after N seconds of master idle */</span><br><span class="line">    client *master;     /* Client that is master for this slave */</span><br><span class="line">    client *cached_master; /* Cached master to be reused for PSYNC. */</span><br><span class="line">    int repl_syncio_timeout; /* Timeout for synchronous I/O calls */</span><br><span class="line">    int repl_state;          /* Replication status if the instance is a slave */</span><br><span class="line">    off_t repl_transfer_size; /* Size of RDB to read from master during sync. */</span><br><span class="line">    off_t repl_transfer_read; /* Amount of RDB read from master during sync. */</span><br><span class="line">    off_t repl_transfer_last_fsync_off; /* Offset when we fsync-ed last time. */</span><br><span class="line">    int repl_transfer_s;     /* Slave -&gt; Master SYNC socket */</span><br><span class="line">    int repl_transfer_fd;    /* Slave -&gt; Master SYNC temp file descriptor */</span><br><span class="line">    char *repl_transfer_tmpfile; /* Slave-&gt; master SYNC temp file name */</span><br><span class="line">    time_t repl_transfer_lastio; /* Unix time of the latest read, for timeout */</span><br><span class="line">    int repl_serve_stale_data; /* Serve stale data when link is down? */</span><br><span class="line">    int repl_slave_ro;          /* Slave is read only? */</span><br><span class="line">    time_t repl_down_since; /* Unix time at which link with master went down */</span><br><span class="line">    int repl_disable_tcp_nodelay;   /* Disable TCP_NODELAY after SYNC? */</span><br><span class="line">    int slave_priority;             /* Reported in INFO and used by Sentinel. */</span><br><span class="line">    int slave_announce_port;        /* Give the master this listening port. */</span><br><span class="line">    char *slave_announce_ip;        /* Give the master this ip address. */</span><br><span class="line">    /* The following two fields is where we store master PSYNC replid/offset</span><br><span class="line">     * while the PSYNC is in progress. At the end we&apos;ll copy the fields into</span><br><span class="line">     * the server-&gt;master client structure. */</span><br><span class="line">    char master_replid[CONFIG_RUN_ID_SIZE+1];  /* Master PSYNC runid. */</span><br><span class="line">    long long master_initial_offset;           /* Master PSYNC offset. */</span><br><span class="line">    int repl_slave_lazy_flush;          /* Lazy FLUSHALL before loading DB? */</span><br><span class="line">    /* Replication script cache. */</span><br><span class="line">    dict *repl_scriptcache_dict;        /* SHA1 all slaves are aware of. */</span><br><span class="line">    list *repl_scriptcache_fifo;        /* First in, first out LRU eviction. */</span><br><span class="line">    unsigned int repl_scriptcache_size; /* Max number of elements. */</span><br><span class="line">    /* Synchronous replication. */</span><br><span class="line">    list *clients_waiting_acks;         /* Clients waiting in WAIT command. */</span><br><span class="line">    int get_ack_from_slaves;            /* If true we send REPLCONF GETACK. */</span><br><span class="line">    /* Limits */</span><br><span class="line">    unsigned int maxclients;            /* Max number of simultaneous clients */</span><br><span class="line">    unsigned long long maxmemory;   /* Max number of memory bytes to use */</span><br><span class="line">    int maxmemory_policy;           /* Policy for key eviction */</span><br><span class="line">    int maxmemory_samples;          /* Pricision of random sampling */</span><br><span class="line">    int lfu_log_factor;             /* LFU logarithmic counter factor. */</span><br><span class="line">    int lfu_decay_time;             /* LFU counter decay factor. */</span><br><span class="line">    long long proto_max_bulk_len;   /* Protocol bulk length maximum size. */</span><br><span class="line">    /* Blocked clients */</span><br><span class="line">    unsigned int blocked_clients;   /* # of clients executing a blocking cmd.*/</span><br><span class="line">    unsigned int blocked_clients_by_type[BLOCKED_NUM];</span><br><span class="line">    list *unblocked_clients; /* list of clients to unblock before next loop */</span><br><span class="line">    list *ready_keys;        /* List of readyList structures for BLPOP &amp; co */</span><br><span class="line">    /* Sort parameters - qsort_r() is only available under BSD so we</span><br><span class="line">     * have to take this state global, in order to pass it to sortCompare() */</span><br><span class="line">    int sort_desc;</span><br><span class="line">    int sort_alpha;</span><br><span class="line">    int sort_bypattern;</span><br><span class="line">    int sort_store;</span><br><span class="line">    /* Zip structure config, see redis.conf for more information  */</span><br><span class="line">    size_t hash_max_ziplist_entries;</span><br><span class="line">    size_t hash_max_ziplist_value;</span><br><span class="line">    size_t set_max_intset_entries;</span><br><span class="line">    size_t zset_max_ziplist_entries;</span><br><span class="line">    size_t zset_max_ziplist_value;</span><br><span class="line">    size_t hll_sparse_max_bytes;</span><br><span class="line">    size_t stream_node_max_bytes;</span><br><span class="line">    int64_t stream_node_max_entries;</span><br><span class="line">    /* List parameters */</span><br><span class="line">    int list_max_ziplist_size;</span><br><span class="line">    int list_compress_depth;</span><br><span class="line">    /* time cache */</span><br><span class="line">    time_t unixtime;    /* Unix time sampled every cron cycle. */</span><br><span class="line">    long long mstime;   /* Like &apos;unixtime&apos; but with milliseconds resolution. */</span><br><span class="line">    /* Pubsub */</span><br><span class="line">    dict *pubsub_channels;  /* Map channels to list of subscribed clients */</span><br><span class="line">    list *pubsub_patterns;  /* A list of pubsub_patterns */</span><br><span class="line">    int notify_keyspace_events; /* Events to propagate via Pub/Sub. This is an</span><br><span class="line">                                   xor of NOTIFY_... flags. */</span><br><span class="line">    /* Cluster */</span><br><span class="line">    int cluster_enabled;      /* Is cluster enabled? */</span><br><span class="line">    mstime_t cluster_node_timeout; /* Cluster node timeout. */</span><br><span class="line">    char *cluster_configfile; /* Cluster auto-generated config file name. */</span><br><span class="line">    struct clusterState *cluster;  /* State of the cluster */</span><br><span class="line">    int cluster_migration_barrier; /* Cluster replicas migration barrier. */</span><br><span class="line">    int cluster_slave_validity_factor; /* Slave max data age for failover. */</span><br><span class="line">    int cluster_require_full_coverage; /* If true, put the cluster down if</span><br><span class="line">                                          there is at least an uncovered slot.*/</span><br><span class="line">    int cluster_slave_no_failover;  /* Prevent slave from starting a failover</span><br><span class="line">                                       if the master is in failure state. */</span><br><span class="line">    char *cluster_announce_ip;  /* IP address to announce on cluster bus. */</span><br><span class="line">    int cluster_announce_port;     /* base port to announce on cluster bus. */</span><br><span class="line">    int cluster_announce_bus_port; /* bus port to announce on cluster bus. */</span><br><span class="line">    /* Scripting */</span><br><span class="line">    lua_State *lua; /* The Lua interpreter. We use just one for all clients */</span><br><span class="line">    client *lua_client;   /* The &quot;fake client&quot; to query Redis from Lua */</span><br><span class="line">    client *lua_caller;   /* The client running EVAL right now, or NULL */</span><br><span class="line">    dict *lua_scripts;         /* A dictionary of SHA1 -&gt; Lua scripts */</span><br><span class="line">    mstime_t lua_time_limit;  /* Script timeout in milliseconds */</span><br><span class="line">    mstime_t lua_time_start;  /* Start time of script, milliseconds time */</span><br><span class="line">    int lua_write_dirty;  /* True if a write command was called during the</span><br><span class="line">                             execution of the current script. */</span><br><span class="line">    int lua_random_dirty; /* True if a random command was called during the</span><br><span class="line">                             execution of the current script. */</span><br><span class="line">    int lua_replicate_commands; /* True if we are doing single commands repl. */</span><br><span class="line">    int lua_multi_emitted;/* True if we already proagated MULTI. */</span><br><span class="line">    int lua_repl;         /* Script replication flags for redis.set_repl(). */</span><br><span class="line">    int lua_timedout;     /* True if we reached the time limit for script</span><br><span class="line">                             execution. */</span><br><span class="line">    int lua_kill;         /* Kill the script if true. */</span><br><span class="line">    int lua_always_replicate_commands; /* Default replication type. */</span><br><span class="line">    /* Lazy free */</span><br><span class="line">    int lazyfree_lazy_eviction;</span><br><span class="line">    int lazyfree_lazy_expire;</span><br><span class="line">    int lazyfree_lazy_server_del;</span><br><span class="line">    /* Latency monitor */</span><br><span class="line">    long long latency_monitor_threshold;</span><br><span class="line">    dict *latency_events;</span><br><span class="line">    /* Assert &amp; bug reporting */</span><br><span class="line">    const char *assert_failed;</span><br><span class="line">    const char *assert_file;</span><br><span class="line">    int assert_line;</span><br><span class="line">    int bug_report_start; /* True if bug report header was already logged. */</span><br><span class="line">    int watchdog_period;  /* Software watchdog period in ms. 0 = off */</span><br><span class="line">    /* System hardware info */</span><br><span class="line">    size_t system_memory_size;  /* Total memory in system as reported by OS */</span><br><span class="line"></span><br><span class="line">    /* Mutexes used to protect atomic variables when atomic builtins are</span><br><span class="line">     * not available. */</span><br><span class="line">    pthread_mutex_t lruclock_mutex;</span><br><span class="line">    pthread_mutex_t next_client_id_mutex;</span><br><span class="line">    pthread_mutex_t unixtime_mutex;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="initServerConfig"><a href="#initServerConfig" class="headerlink" title="initServerConfig"></a>initServerConfig</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line">void initServerConfig(void) &#123;</span><br><span class="line">    int j;</span><br><span class="line"></span><br><span class="line">    pthread_mutex_init(&amp;server.next_client_id_mutex,NULL);</span><br><span class="line">    pthread_mutex_init(&amp;server.lruclock_mutex,NULL);</span><br><span class="line">    pthread_mutex_init(&amp;server.unixtime_mutex,NULL);</span><br><span class="line"></span><br><span class="line">    getRandomHexChars(server.runid,CONFIG_RUN_ID_SIZE);</span><br><span class="line">    server.runid[CONFIG_RUN_ID_SIZE] = &apos;\0&apos;;</span><br><span class="line">    changeReplicationId();</span><br><span class="line">    clearReplicationId2();</span><br><span class="line">    server.configfile = NULL;</span><br><span class="line">    server.executable = NULL;</span><br><span class="line">    server.hz = CONFIG_DEFAULT_HZ;</span><br><span class="line">    server.arch_bits = (sizeof(long) == 8) ? 64 : 32;</span><br><span class="line">    server.port = CONFIG_DEFAULT_SERVER_PORT;</span><br><span class="line">    server.tcp_backlog = CONFIG_DEFAULT_TCP_BACKLOG;</span><br><span class="line">    server.bindaddr_count = 0;</span><br><span class="line">    server.unixsocket = NULL;</span><br><span class="line">    server.unixsocketperm = CONFIG_DEFAULT_UNIX_SOCKET_PERM;</span><br><span class="line">    server.ipfd_count = 0;</span><br><span class="line">    server.sofd = -1;</span><br><span class="line">    server.protected_mode = CONFIG_DEFAULT_PROTECTED_MODE;</span><br><span class="line">    server.dbnum = CONFIG_DEFAULT_DBNUM;</span><br><span class="line">    server.verbosity = CONFIG_DEFAULT_VERBOSITY;</span><br><span class="line">    server.maxidletime = CONFIG_DEFAULT_CLIENT_TIMEOUT;</span><br><span class="line">    server.tcpkeepalive = CONFIG_DEFAULT_TCP_KEEPALIVE;</span><br><span class="line">    server.active_expire_enabled = 1;</span><br><span class="line">    server.active_defrag_enabled = CONFIG_DEFAULT_ACTIVE_DEFRAG;</span><br><span class="line">    server.active_defrag_ignore_bytes = CONFIG_DEFAULT_DEFRAG_IGNORE_BYTES;</span><br><span class="line">    server.active_defrag_threshold_lower = CONFIG_DEFAULT_DEFRAG_THRESHOLD_LOWER;</span><br><span class="line">    server.active_defrag_threshold_upper = CONFIG_DEFAULT_DEFRAG_THRESHOLD_UPPER;</span><br><span class="line">    server.active_defrag_cycle_min = CONFIG_DEFAULT_DEFRAG_CYCLE_MIN;</span><br><span class="line">    server.active_defrag_cycle_max = CONFIG_DEFAULT_DEFRAG_CYCLE_MAX;</span><br><span class="line">    server.active_defrag_max_scan_fields = CONFIG_DEFAULT_DEFRAG_MAX_SCAN_FIELDS;</span><br><span class="line">    server.proto_max_bulk_len = CONFIG_DEFAULT_PROTO_MAX_BULK_LEN;</span><br><span class="line">    server.client_max_querybuf_len = PROTO_MAX_QUERYBUF_LEN;</span><br><span class="line">    server.saveparams = NULL;</span><br><span class="line">    server.loading = 0;</span><br><span class="line">    server.logfile = zstrdup(CONFIG_DEFAULT_LOGFILE);</span><br><span class="line">    server.syslog_enabled = CONFIG_DEFAULT_SYSLOG_ENABLED;</span><br><span class="line">    server.syslog_ident = zstrdup(CONFIG_DEFAULT_SYSLOG_IDENT);</span><br><span class="line">    server.syslog_facility = LOG_LOCAL0;</span><br><span class="line">    server.daemonize = CONFIG_DEFAULT_DAEMONIZE;</span><br><span class="line">    server.supervised = 0;</span><br><span class="line">    server.supervised_mode = SUPERVISED_NONE;</span><br><span class="line">    server.aof_state = AOF_OFF;</span><br><span class="line">    server.aof_fsync = CONFIG_DEFAULT_AOF_FSYNC;</span><br><span class="line">    server.aof_no_fsync_on_rewrite = CONFIG_DEFAULT_AOF_NO_FSYNC_ON_REWRITE;</span><br><span class="line">    server.aof_rewrite_perc = AOF_REWRITE_PERC;</span><br><span class="line">    server.aof_rewrite_min_size = AOF_REWRITE_MIN_SIZE;</span><br><span class="line">    server.aof_rewrite_base_size = 0;</span><br><span class="line">    server.aof_rewrite_scheduled = 0;</span><br><span class="line">    server.aof_last_fsync = time(NULL);</span><br><span class="line">    server.aof_rewrite_time_last = -1;</span><br><span class="line">    server.aof_rewrite_time_start = -1;</span><br><span class="line">    server.aof_lastbgrewrite_status = C_OK;</span><br><span class="line">    server.aof_delayed_fsync = 0;</span><br><span class="line">    server.aof_fd = -1;</span><br><span class="line">    server.aof_selected_db = -1; /* Make sure the first time will not match */</span><br><span class="line">    server.aof_flush_postponed_start = 0;</span><br><span class="line">    server.aof_rewrite_incremental_fsync = CONFIG_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC;</span><br><span class="line">    server.aof_load_truncated = CONFIG_DEFAULT_AOF_LOAD_TRUNCATED;</span><br><span class="line">    server.aof_use_rdb_preamble = CONFIG_DEFAULT_AOF_USE_RDB_PREAMBLE;</span><br><span class="line">    server.pidfile = NULL;</span><br><span class="line">    server.rdb_filename = zstrdup(CONFIG_DEFAULT_RDB_FILENAME);</span><br><span class="line">    server.aof_filename = zstrdup(CONFIG_DEFAULT_AOF_FILENAME);</span><br><span class="line">    server.requirepass = NULL;</span><br><span class="line">    server.rdb_compression = CONFIG_DEFAULT_RDB_COMPRESSION;</span><br><span class="line">    server.rdb_checksum = CONFIG_DEFAULT_RDB_CHECKSUM;</span><br><span class="line">    server.stop_writes_on_bgsave_err = CONFIG_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR;</span><br><span class="line">    server.activerehashing = CONFIG_DEFAULT_ACTIVE_REHASHING;</span><br><span class="line">    server.active_defrag_running = 0;</span><br><span class="line">    server.notify_keyspace_events = 0;</span><br><span class="line">    server.maxclients = CONFIG_DEFAULT_MAX_CLIENTS;</span><br><span class="line">    server.blocked_clients = 0;</span><br><span class="line">    memset(server.blocked_clients_by_type,0,</span><br><span class="line">           sizeof(server.blocked_clients_by_type));</span><br><span class="line">    server.maxmemory = CONFIG_DEFAULT_MAXMEMORY;</span><br><span class="line">    server.maxmemory_policy = CONFIG_DEFAULT_MAXMEMORY_POLICY;</span><br><span class="line">    server.maxmemory_samples = CONFIG_DEFAULT_MAXMEMORY_SAMPLES;</span><br><span class="line">    server.lfu_log_factor = CONFIG_DEFAULT_LFU_LOG_FACTOR;</span><br><span class="line">    server.lfu_decay_time = CONFIG_DEFAULT_LFU_DECAY_TIME;</span><br><span class="line">    server.hash_max_ziplist_entries = OBJ_HASH_MAX_ZIPLIST_ENTRIES;</span><br><span class="line">    server.hash_max_ziplist_value = OBJ_HASH_MAX_ZIPLIST_VALUE;</span><br><span class="line">    server.list_max_ziplist_size = OBJ_LIST_MAX_ZIPLIST_SIZE;</span><br><span class="line">    server.list_compress_depth = OBJ_LIST_COMPRESS_DEPTH;</span><br><span class="line">    server.set_max_intset_entries = OBJ_SET_MAX_INTSET_ENTRIES;</span><br><span class="line">    server.zset_max_ziplist_entries = OBJ_ZSET_MAX_ZIPLIST_ENTRIES;</span><br><span class="line">    server.zset_max_ziplist_value = OBJ_ZSET_MAX_ZIPLIST_VALUE;</span><br><span class="line">    server.hll_sparse_max_bytes = CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES;</span><br><span class="line">    server.stream_node_max_bytes = OBJ_STREAM_NODE_MAX_BYTES;</span><br><span class="line">    server.stream_node_max_entries = OBJ_STREAM_NODE_MAX_ENTRIES;</span><br><span class="line">    server.shutdown_asap = 0;</span><br><span class="line">    server.cluster_enabled = 0;</span><br><span class="line">    server.cluster_node_timeout = CLUSTER_DEFAULT_NODE_TIMEOUT;</span><br><span class="line">    server.cluster_migration_barrier = CLUSTER_DEFAULT_MIGRATION_BARRIER;</span><br><span class="line">    server.cluster_slave_validity_factor = CLUSTER_DEFAULT_SLAVE_VALIDITY;</span><br><span class="line">    server.cluster_require_full_coverage = CLUSTER_DEFAULT_REQUIRE_FULL_COVERAGE;</span><br><span class="line">    server.cluster_slave_no_failover = CLUSTER_DEFAULT_SLAVE_NO_FAILOVER;</span><br><span class="line">    server.cluster_configfile = zstrdup(CONFIG_DEFAULT_CLUSTER_CONFIG_FILE);</span><br><span class="line">    server.cluster_announce_ip = CONFIG_DEFAULT_CLUSTER_ANNOUNCE_IP;</span><br><span class="line">    server.cluster_announce_port = CONFIG_DEFAULT_CLUSTER_ANNOUNCE_PORT;</span><br><span class="line">    server.cluster_announce_bus_port = CONFIG_DEFAULT_CLUSTER_ANNOUNCE_BUS_PORT;</span><br><span class="line">    server.migrate_cached_sockets = dictCreate(&amp;migrateCacheDictType,NULL);</span><br><span class="line">    server.next_client_id = 1; /* Client IDs, start from 1 .*/</span><br><span class="line">    server.loading_process_events_interval_bytes = (1024*1024*2);</span><br><span class="line">    server.lazyfree_lazy_eviction = CONFIG_DEFAULT_LAZYFREE_LAZY_EVICTION;</span><br><span class="line">    server.lazyfree_lazy_expire = CONFIG_DEFAULT_LAZYFREE_LAZY_EXPIRE;</span><br><span class="line">    server.lazyfree_lazy_server_del = CONFIG_DEFAULT_LAZYFREE_LAZY_SERVER_DEL;</span><br><span class="line">    server.always_show_logo = CONFIG_DEFAULT_ALWAYS_SHOW_LOGO;</span><br><span class="line">    server.lua_time_limit = LUA_SCRIPT_TIME_LIMIT;</span><br><span class="line"></span><br><span class="line">    unsigned int lruclock = getLRUClock();</span><br><span class="line">    atomicSet(server.lruclock,lruclock);</span><br><span class="line">    resetServerSaveParams();</span><br><span class="line"></span><br><span class="line">    appendServerSaveParams(60*60,1);  /* save after 1 hour and 1 change */</span><br><span class="line">    appendServerSaveParams(300,100);  /* save after 5 minutes and 100 changes */</span><br><span class="line">    appendServerSaveParams(60,10000); /* save after 1 minute and 10000 changes */</span><br><span class="line"></span><br><span class="line">    /* Replication related */</span><br><span class="line">    server.masterauth = NULL;</span><br><span class="line">    server.masterhost = NULL;</span><br><span class="line">    server.masterport = 6379;</span><br><span class="line">    server.master = NULL;</span><br><span class="line">    server.cached_master = NULL;</span><br><span class="line">    server.master_initial_offset = -1;</span><br><span class="line">    server.repl_state = REPL_STATE_NONE;</span><br><span class="line">    server.repl_syncio_timeout = CONFIG_REPL_SYNCIO_TIMEOUT;</span><br><span class="line">    server.repl_serve_stale_data = CONFIG_DEFAULT_SLAVE_SERVE_STALE_DATA;</span><br><span class="line">    server.repl_slave_ro = CONFIG_DEFAULT_SLAVE_READ_ONLY;</span><br><span class="line">    server.repl_slave_lazy_flush = CONFIG_DEFAULT_SLAVE_LAZY_FLUSH;</span><br><span class="line">    server.repl_down_since = 0; /* Never connected, repl is down since EVER. */</span><br><span class="line">    server.repl_disable_tcp_nodelay = CONFIG_DEFAULT_REPL_DISABLE_TCP_NODELAY;</span><br><span class="line">    server.repl_diskless_sync = CONFIG_DEFAULT_REPL_DISKLESS_SYNC;</span><br><span class="line">    server.repl_diskless_sync_delay = CONFIG_DEFAULT_REPL_DISKLESS_SYNC_DELAY;</span><br><span class="line">    server.repl_ping_slave_period = CONFIG_DEFAULT_REPL_PING_SLAVE_PERIOD;</span><br><span class="line">    server.repl_timeout = CONFIG_DEFAULT_REPL_TIMEOUT;</span><br><span class="line">    server.repl_min_slaves_to_write = CONFIG_DEFAULT_MIN_SLAVES_TO_WRITE;</span><br><span class="line">    server.repl_min_slaves_max_lag = CONFIG_DEFAULT_MIN_SLAVES_MAX_LAG;</span><br><span class="line">    server.slave_priority = CONFIG_DEFAULT_SLAVE_PRIORITY;</span><br><span class="line">    server.slave_announce_ip = CONFIG_DEFAULT_SLAVE_ANNOUNCE_IP;</span><br><span class="line">    server.slave_announce_port = CONFIG_DEFAULT_SLAVE_ANNOUNCE_PORT;</span><br><span class="line">    server.master_repl_offset = 0;</span><br><span class="line"></span><br><span class="line">    /* Replication partial resync backlog */</span><br><span class="line">    server.repl_backlog = NULL;</span><br><span class="line">    server.repl_backlog_size = CONFIG_DEFAULT_REPL_BACKLOG_SIZE;</span><br><span class="line">    server.repl_backlog_histlen = 0;</span><br><span class="line">    server.repl_backlog_idx = 0;</span><br><span class="line">    server.repl_backlog_off = 0;</span><br><span class="line">    server.repl_backlog_time_limit = CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT;</span><br><span class="line">    server.repl_no_slaves_since = time(NULL);</span><br><span class="line"></span><br><span class="line">    /* Client output buffer limits */</span><br><span class="line">    for (j = 0; j &lt; CLIENT_TYPE_OBUF_COUNT; j++)</span><br><span class="line">        server.client_obuf_limits[j] = clientBufferLimitsDefaults[j];</span><br><span class="line"></span><br><span class="line">    /* Double constants initialization */</span><br><span class="line">    R_Zero = 0.0;</span><br><span class="line">    R_PosInf = 1.0/R_Zero;</span><br><span class="line">    R_NegInf = -1.0/R_Zero;</span><br><span class="line">    R_Nan = R_Zero/R_Zero;</span><br><span class="line"></span><br><span class="line">    /* Command table -- we initiialize it here as it is part of the</span><br><span class="line">     * initial configuration, since command names may be changed via</span><br><span class="line">     * redis.conf using the rename-command directive. */</span><br><span class="line">    server.commands = dictCreate(&amp;commandTableDictType,NULL);</span><br><span class="line">    server.orig_commands = dictCreate(&amp;commandTableDictType,NULL);</span><br><span class="line">    populateCommandTable();</span><br><span class="line">    server.delCommand = lookupCommandByCString(&quot;del&quot;);</span><br><span class="line">    server.multiCommand = lookupCommandByCString(&quot;multi&quot;);</span><br><span class="line">    server.lpushCommand = lookupCommandByCString(&quot;lpush&quot;);</span><br><span class="line">    server.lpopCommand = lookupCommandByCString(&quot;lpop&quot;);</span><br><span class="line">    server.rpopCommand = lookupCommandByCString(&quot;rpop&quot;);</span><br><span class="line">    server.zpopminCommand = lookupCommandByCString(&quot;zpopmin&quot;);</span><br><span class="line">    server.zpopmaxCommand = lookupCommandByCString(&quot;zpopmax&quot;);</span><br><span class="line">    server.sremCommand = lookupCommandByCString(&quot;srem&quot;);</span><br><span class="line">    server.execCommand = lookupCommandByCString(&quot;exec&quot;);</span><br><span class="line">    server.expireCommand = lookupCommandByCString(&quot;expire&quot;);</span><br><span class="line">    server.pexpireCommand = lookupCommandByCString(&quot;pexpire&quot;);</span><br><span class="line">    server.xclaimCommand = lookupCommandByCString(&quot;xclaim&quot;);</span><br><span class="line"></span><br><span class="line">    /* Slow log */</span><br><span class="line">    server.slowlog_log_slower_than = CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN;</span><br><span class="line">    server.slowlog_max_len = CONFIG_DEFAULT_SLOWLOG_MAX_LEN;</span><br><span class="line"></span><br><span class="line">    /* Latency monitor */</span><br><span class="line">    server.latency_monitor_threshold = CONFIG_DEFAULT_LATENCY_MONITOR_THRESHOLD;</span><br><span class="line"></span><br><span class="line">    /* Debugging */</span><br><span class="line">    server.assert_failed = &quot;&lt;no assertion failed&gt;&quot;;</span><br><span class="line">    server.assert_file = &quot;&lt;no file&gt;&quot;;</span><br><span class="line">    server.assert_line = 0;</span><br><span class="line">    server.bug_report_start = 0;</span><br><span class="line">    server.watchdog_period = 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="initServer"><a href="#initServer" class="headerlink" title="initServer"></a>initServer</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line">void initServer(void) &#123;</span><br><span class="line">    int j;</span><br><span class="line"></span><br><span class="line">    signal(SIGHUP, SIG_IGN);</span><br><span class="line">    signal(SIGPIPE, SIG_IGN);</span><br><span class="line">    setupSignalHandlers();</span><br><span class="line"></span><br><span class="line">    if (server.syslog_enabled) &#123;</span><br><span class="line">        openlog(server.syslog_ident, LOG_PID | LOG_NDELAY | LOG_NOWAIT,</span><br><span class="line">            server.syslog_facility);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server.pid = getpid();</span><br><span class="line">    server.current_client = NULL;</span><br><span class="line">    server.clients = listCreate();</span><br><span class="line">    server.clients_to_close = listCreate();</span><br><span class="line">    server.slaves = listCreate();</span><br><span class="line">    server.monitors = listCreate();</span><br><span class="line">    server.clients_pending_write = listCreate();</span><br><span class="line">    server.slaveseldb = -1; /* Force to emit the first SELECT command. */</span><br><span class="line">    server.unblocked_clients = listCreate();</span><br><span class="line">    server.ready_keys = listCreate();</span><br><span class="line">    server.clients_waiting_acks = listCreate();</span><br><span class="line">    server.get_ack_from_slaves = 0;</span><br><span class="line">    server.clients_paused = 0;</span><br><span class="line">    server.system_memory_size = zmalloc_get_memory_size();</span><br><span class="line"></span><br><span class="line">    //创建共享对象</span><br><span class="line">    createSharedObjects();</span><br><span class="line">    adjustOpenFilesLimit();</span><br><span class="line">    server.el = aeCreateEventLoop(server.maxclients+CONFIG_FDSET_INCR);</span><br><span class="line">    if (server.el == NULL) &#123;</span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">            &quot;Failed creating the event loop. Error message: &apos;%s&apos;&quot;,</span><br><span class="line">            strerror(errno));</span><br><span class="line">        exit(1);</span><br><span class="line">    &#125;</span><br><span class="line">    server.db = zmalloc(sizeof(redisDb)*server.dbnum);</span><br><span class="line"></span><br><span class="line">    /* Open the TCP listening socket for the user commands. */</span><br><span class="line">    if (server.port != 0 &amp;&amp;</span><br><span class="line">        listenToPort(server.port,server.ipfd,&amp;server.ipfd_count) == C_ERR)</span><br><span class="line">        exit(1);</span><br><span class="line"></span><br><span class="line">    /* Open the listening Unix domain socket. */</span><br><span class="line">    if (server.unixsocket != NULL) &#123;</span><br><span class="line">        unlink(server.unixsocket); /* don&apos;t care if this fails */</span><br><span class="line">        server.sofd = anetUnixServer(server.neterr,server.unixsocket,</span><br><span class="line">            server.unixsocketperm, server.tcp_backlog);</span><br><span class="line">        if (server.sofd == ANET_ERR) &#123;</span><br><span class="line">            serverLog(LL_WARNING, &quot;Opening Unix socket: %s&quot;, server.neterr);</span><br><span class="line">            exit(1);</span><br><span class="line">        &#125;</span><br><span class="line">        anetNonBlock(NULL,server.sofd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* Abort if there are no listening sockets at all. */</span><br><span class="line">    if (server.ipfd_count == 0 &amp;&amp; server.sofd &lt; 0) &#123;</span><br><span class="line">        serverLog(LL_WARNING, &quot;Configured to not listen anywhere, exiting.&quot;);</span><br><span class="line">        exit(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //创建database</span><br><span class="line">    for (j = 0; j &lt; server.dbnum; j++) &#123;</span><br><span class="line">        server.db[j].dict = dictCreate(&amp;dbDictType,NULL);</span><br><span class="line">        server.db[j].expires = dictCreate(&amp;keyptrDictType,NULL);</span><br><span class="line">        server.db[j].blocking_keys = dictCreate(&amp;keylistDictType,NULL);</span><br><span class="line">        server.db[j].ready_keys = dictCreate(&amp;objectKeyPointerValueDictType,NULL);</span><br><span class="line">        server.db[j].watched_keys = dictCreate(&amp;keylistDictType,NULL);</span><br><span class="line">        server.db[j].id = j;</span><br><span class="line">        server.db[j].avg_ttl = 0;</span><br><span class="line">        server.db[j].defrag_later = listCreate();</span><br><span class="line">    &#125;</span><br><span class="line">    evictionPoolAlloc(); /* Initialize the LRU keys pool. */</span><br><span class="line">    server.pubsub_channels = dictCreate(&amp;keylistDictType,NULL);</span><br><span class="line">    server.pubsub_patterns = listCreate();</span><br><span class="line">    listSetFreeMethod(server.pubsub_patterns,freePubsubPattern);</span><br><span class="line">    listSetMatchMethod(server.pubsub_patterns,listMatchPubsubPattern);</span><br><span class="line">    server.cronloops = 0;</span><br><span class="line">    server.rdb_child_pid = -1;</span><br><span class="line">    server.aof_child_pid = -1;</span><br><span class="line">    server.rdb_child_type = RDB_CHILD_TYPE_NONE;</span><br><span class="line">    server.rdb_bgsave_scheduled = 0;</span><br><span class="line">    server.child_info_pipe[0] = -1;</span><br><span class="line">    server.child_info_pipe[1] = -1;</span><br><span class="line">    server.child_info_data.magic = 0;</span><br><span class="line">    aofRewriteBufferReset();</span><br><span class="line">    server.aof_buf = sdsempty();</span><br><span class="line">    server.lastsave = time(NULL); /* At startup we consider the DB saved. */</span><br><span class="line">    server.lastbgsave_try = 0;    /* At startup we never tried to BGSAVE. */</span><br><span class="line">    server.rdb_save_time_last = -1;</span><br><span class="line">    server.rdb_save_time_start = -1;</span><br><span class="line">    server.dirty = 0;</span><br><span class="line">    resetServerStats();</span><br><span class="line">    /* A few stats we don&apos;t want to reset: server startup time, and peak mem. */</span><br><span class="line">    server.stat_starttime = time(NULL);</span><br><span class="line">    server.stat_peak_memory = 0;</span><br><span class="line">    server.stat_rdb_cow_bytes = 0;</span><br><span class="line">    server.stat_aof_cow_bytes = 0;</span><br><span class="line">    server.cron_malloc_stats.zmalloc_used = 0;</span><br><span class="line">    server.cron_malloc_stats.process_rss = 0;</span><br><span class="line">    server.cron_malloc_stats.allocator_allocated = 0;</span><br><span class="line">    server.cron_malloc_stats.allocator_active = 0;</span><br><span class="line">    server.cron_malloc_stats.allocator_resident = 0;</span><br><span class="line">    server.lastbgsave_status = C_OK;</span><br><span class="line">    server.aof_last_write_status = C_OK;</span><br><span class="line">    server.aof_last_write_errno = 0;</span><br><span class="line">    server.repl_good_slaves_count = 0;</span><br><span class="line">    updateCachedTime();</span><br><span class="line"></span><br><span class="line">    /* Create the timer callback, this is our way to process many background</span><br><span class="line">     * operations incrementally, like clients timeout, eviction of unaccessed</span><br><span class="line">     * expired keys and so forth. */</span><br><span class="line">    if (aeCreateTimeEvent(server.el, 1, serverCron, NULL, NULL) == AE_ERR) &#123;</span><br><span class="line">        serverPanic(&quot;Can&apos;t create event loop timers.&quot;);</span><br><span class="line">        exit(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* Create an event handler for accepting new connections in TCP and Unix</span><br><span class="line">     * domain sockets. */</span><br><span class="line">    for (j = 0; j &lt; server.ipfd_count; j++) &#123;</span><br><span class="line">        if (aeCreateFileEvent(server.el, server.ipfd[j], AE_READABLE,</span><br><span class="line">            acceptTcpHandler,NULL) == AE_ERR)</span><br><span class="line">            &#123;</span><br><span class="line">                serverPanic(</span><br><span class="line">                    &quot;Unrecoverable error creating server.ipfd file event.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (server.sofd &gt; 0 &amp;&amp; aeCreateFileEvent(server.el,server.sofd,AE_READABLE,</span><br><span class="line">        acceptUnixHandler,NULL) == AE_ERR) serverPanic(&quot;Unrecoverable error creating server.sofd file event.&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /* Register a readable event for the pipe used to awake the event loop</span><br><span class="line">     * when a blocked client in a module needs attention. */</span><br><span class="line">    if (aeCreateFileEvent(server.el, server.module_blocked_pipe[0], AE_READABLE,</span><br><span class="line">        moduleBlockedClientPipeReadable,NULL) == AE_ERR) &#123;</span><br><span class="line">            serverPanic(</span><br><span class="line">                &quot;Error registering the readable event for the module &quot;</span><br><span class="line">                &quot;blocked clients subsystem.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* Open the AOF file if needed. */</span><br><span class="line">    if (server.aof_state == AOF_ON) &#123;</span><br><span class="line">        //开启aof文件读取</span><br><span class="line">        server.aof_fd = open(server.aof_filename,</span><br><span class="line">                               O_WRONLY|O_APPEND|O_CREAT,0644);</span><br><span class="line">        if (server.aof_fd == -1) &#123;</span><br><span class="line">            serverLog(LL_WARNING, &quot;Can&apos;t open the append-only file: %s&quot;,</span><br><span class="line">                strerror(errno));</span><br><span class="line">            exit(1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* 32 bit instances are limited to 4GB of address space, so if there is</span><br><span class="line">     * no explicit limit in the user provided configuration we set a limit</span><br><span class="line">     * at 3 GB using maxmemory with &apos;noeviction&apos; policy&apos;. This avoids</span><br><span class="line">     * useless crashes of the Redis instance for out of memory. */</span><br><span class="line">    if (server.arch_bits == 32 &amp;&amp; server.maxmemory == 0) &#123;</span><br><span class="line">        serverLog(LL_WARNING,&quot;Warning: 32 bit instance detected but no memory limit set. Setting 3 GB maxmemory limit with &apos;noeviction&apos; policy now.&quot;);</span><br><span class="line">        server.maxmemory = 3072LL*(1024*1024); /* 3 GB */</span><br><span class="line">        server.maxmemory_policy = MAXMEMORY_NO_EVICTION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (server.cluster_enabled) clusterInit();</span><br><span class="line">    replicationScriptCacheInit();</span><br><span class="line">    scriptingInit(1);</span><br><span class="line">    slowlogInit();</span><br><span class="line">    latencyMonitorInit();</span><br><span class="line">    bioInit();</span><br><span class="line">    server.initial_memory_usage = zmalloc_used_memory();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
    </div>

    
    
    
        
      

      <footer class="post-footer">
          
            
          
          <div class="post-tags">
            
              <a href="/tags/redis/" rel="tag"># redis</a>
            
          </div>
        

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2019/02/09/Redis源码剖析之命令执行核心/" rel="next" title="Redis源码剖析之命令执行核心">
                  <i class="fa fa-chevron-left"></i> Redis源码剖析之命令执行核心
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2019/02/09/Redis技术分享/" rel="prev" title="Redis技术分享">
                  Redis技术分享 <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#服务器结构"><span class="nav-number">1.</span> <span class="nav-text">服务器结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务器初始化"><span class="nav-number">2.</span> <span class="nav-text">服务器初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#serverCron函数"><span class="nav-number">2.1.</span> <span class="nav-text">serverCron函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#databasesCron"><span class="nav-number">2.2.</span> <span class="nav-text">databasesCron</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redisServer-initServerConfig-initServer源码"><span class="nav-number">3.</span> <span class="nav-text">redisServer/initServerConfig/initServer源码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#redisServer"><span class="nav-number">3.1.</span> <span class="nav-text">redisServer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initServerConfig"><span class="nav-number">3.2.</span> <span class="nav-text">initServerConfig</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initServer"><span class="nav-number">3.3.</span> <span class="nav-text">initServer</span></a></li></ol></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/images/avatar.jpg"
      alt="蝉">
  <p class="site-author-name" itemprop="name">蝉</p>
  <div class="site-description" itemprop="description">Another way to laugh !</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">107</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">categories</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        <span class="site-state-item-count">70</span>
        <span class="site-state-item-name">tags</span>
        </a>
      </div>
    
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://github.com/lazycece" title="GitHub &rarr; https://github.com/lazycece" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="mailto:lazycece@qq.com" title="E-Mail &rarr; mailto:lazycece@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://blog.csdn.net/qq_28851503" title="CSDN &rarr; https://blog.csdn.net/qq_28851503" rel="noopener" target="_blank"><i class="fa fa-fw fa-vk"></i>CSDN</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://leetcode-cn.com/u/lazycece" title="LeetCode &rarr; https://leetcode-cn.com/u/lazycece" rel="noopener" target="_blank"><i class="fa fa-fw fa-vk"></i>LeetCode</a>
      </span>
    
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">蝉</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.4.0</div>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
  
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
  
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/pisces.js?v=7.4.0"></script>
<script src="/js/next-boot.js?v=7.4.0"></script><script src="/js/bookmark.js?v=7.4.0"></script>



  

















<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme: 'forest',
      logLevel: 3,
      flowchart: { curve: 'linear' },
      gantt: { axisFormat: '%m/%d/%Y' },
      sequence: { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>




  

  

  

</body>
</html>
